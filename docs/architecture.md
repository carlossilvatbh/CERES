# Arquitetura do Sistema CERES

## üìñ √çndice

- [Vis√£o Geral](#vis√£o-geral)
- [Arquitetura de Alto N√≠vel](#arquitetura-de-alto-n√≠vel)
- [Componentes](#componentes)
- [Fluxo de Dados](#fluxo-de-dados)
- [Seguran√ßa](#seguran√ßa)
- [Escalabilidade](#escalabilidade)
- [Monitoramento](#monitoramento)

## üéØ Vis√£o Geral

O CERES √© constru√≠do com uma arquitetura moderna de microservi√ßos, projetada para alta disponibilidade, escalabilidade e conformidade regulat√≥ria.

### Princ√≠pios Arquiteturais

- **Microservi√ßos**: Componentes independentes e especializados
- **API-First**: Todas as funcionalidades expostas via APIs REST
- **Event-Driven**: Comunica√ß√£o ass√≠ncrona entre servi√ßos
- **Cloud-Native**: Pronto para deployment em nuvem
- **Security by Design**: Seguran√ßa integrada em todas as camadas

## üèóÔ∏è Arquitetura de Alto N√≠vel

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Web Browser   ‚îÇ    ‚îÇ   Mobile App    ‚îÇ    ‚îÇ   Third-party   ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ      APIs       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                      ‚îÇ                      ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ      Load Balancer        ‚îÇ
                    ‚îÇ        (Nginx)            ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                  ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ      API Gateway          ‚îÇ
                    ‚îÇ        (Kong)             ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                  ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                         ‚îÇ                         ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Frontend     ‚îÇ    ‚îÇ      Backend         ‚îÇ    ‚îÇ   External      ‚îÇ
‚îÇ   (React)      ‚îÇ    ‚îÇ     Services         ‚îÇ    ‚îÇ   Services      ‚îÇ
‚îÇ                ‚îÇ    ‚îÇ    (Django/DRF)      ‚îÇ    ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ     Message Queue       ‚îÇ
                    ‚îÇ       (Kafka)           ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ      Database           ‚îÇ
                    ‚îÇ    (PostgreSQL)         ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîß Componentes

### Frontend Layer

#### React Application
- **Framework**: React 18+ com Vite
- **State Management**: Context API + Hooks
- **Styling**: Tailwind CSS
- **Routing**: React Router v6
- **HTTP Client**: Axios
- **Authentication**: JWT tokens

**Responsabilidades:**
- Interface do usu√°rio
- Valida√ß√£o de formul√°rios
- Gerenciamento de estado local
- Comunica√ß√£o com APIs

### API Gateway

#### Kong Gateway
- **Rate Limiting**: Controle de taxa por usu√°rio/IP
- **Authentication**: Valida√ß√£o de JWT
- **Load Balancing**: Distribui√ß√£o de carga
- **Logging**: Logs centralizados
- **Monitoring**: M√©tricas de performance

**Configura√ß√£o:**
```yaml
services:
  - name: ceres-backend
    url: http://backend:8000
    routes:
      - name: api-route
        paths: ["/api"]
        methods: ["GET", "POST", "PUT", "DELETE"]
```

### Backend Services

#### Customer Enrollment Service
- **Responsabilidade**: Gest√£o de clientes
- **Endpoints**: CRUD de clientes, valida√ß√µes
- **Integra√ß√µes**: Document Processing, Screening

#### Document Processing Service
- **Responsabilidade**: OCR e an√°lise de documentos
- **Tecnologias**: Tesseract, PyPDF2, PIL
- **Funcionalidades**: 
  - Extra√ß√£o de texto
  - An√°lise forense
  - Valida√ß√£o de autenticidade

#### Sanctions Screening Service
- **Responsabilidade**: Verifica√ß√£o contra listas restritivas
- **Fontes**: 20+ APIs de dados abertos
- **Algoritmos**: Fuzzy matching, scoring
- **Performance**: Cache Redis, processamento ass√≠ncrono

#### Risk Assessment Service
- **Responsabilidade**: C√°lculo de scores de risco
- **Algoritmos**: Machine Learning, regras de neg√≥cio
- **Inputs**: Dados do cliente, hist√≥rico, screening

#### Report Generation Service
- **Responsabilidade**: Gera√ß√£o de relat√≥rios
- **Formatos**: PDF, Excel, CSV
- **Templates**: Jinja2, WeasyPrint
- **Agendamento**: Celery Beat

### Data Layer

#### PostgreSQL Database
```sql
-- Estrutura principal
Customers (id, personal_data, contact_info, risk_level)
Documents (id, customer_id, file_path, extracted_data)
Screenings (id, customer_id, results, risk_score)
Reports (id, type, parameters, file_path)
Audit_Logs (id, user_id, action, timestamp, details)
```

#### Redis Cache
- **Session Storage**: Dados de sess√£o JWT
- **API Cache**: Respostas de APIs externas
- **Rate Limiting**: Contadores de requisi√ß√µes
- **Task Queue**: Filas Celery

### Message Queue

#### Apache Kafka
- **Topics**:
  - `customer.events`: Eventos de clientes
  - `document.events`: Eventos de documentos
  - `screening.events`: Eventos de screening
  - `audit.events`: Eventos de auditoria

### External Integrations

#### Data Sources
- **OFAC**: API REST, atualiza√ß√£o di√°ria
- **UN**: XML feed, parsing autom√°tico
- **EU**: JSON API, webhook notifications
- **OpenSanctions**: GraphQL API

## üîÑ Fluxo de Dados

### Cadastro de Cliente

```mermaid
sequenceDiagram
    participant U as User
    participant F as Frontend
    participant G as API Gateway
    participant C as Customer Service
    participant D as Document Service
    participant S as Screening Service
    participant DB as Database
    participant Q as Message Queue

    U->>F: Preenche formul√°rio
    F->>G: POST /customers
    G->>C: Valida e cria cliente
    C->>DB: Salva dados
    C->>Q: Publica customer.created
    Q->>D: Trigger document processing
    Q->>S: Trigger screening
    S->>DB: Salva resultados
    S->>Q: Publica screening.completed
    Q->>C: Atualiza risk_level
    C->>F: Retorna cliente criado
```

### Processamento de Documento

```mermaid
sequenceDiagram
    participant U as User
    participant F as Frontend
    participant D as Document Service
    participant OCR as OCR Engine
    participant FA as Forensic Analysis
    participant DB as Database

    U->>F: Upload documento
    F->>D: POST /documents
    D->>OCR: Extrai texto
    OCR->>D: Texto extra√≠do
    D->>FA: Analisa autenticidade
    FA->>D: Score de autenticidade
    D->>DB: Salva resultados
    D->>F: Retorna status
```

## üõ°Ô∏è Seguran√ßa

### Autentica√ß√£o e Autoriza√ß√£o

#### JWT (JSON Web Tokens)
```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "user_id": "uuid",
    "username": "admin",
    "roles": ["compliance_officer"],
    "permissions": ["read:customers", "write:reports"],
    "exp": 1640995200,
    "iat": 1640991600
  }
}
```

#### RBAC (Role-Based Access Control)
- **Admin**: Acesso total
- **Compliance Officer**: Screening, relat√≥rios
- **Analyst**: Visualiza√ß√£o, an√°lise
- **Auditor**: Apenas leitura

### Criptografia

#### Dados em Tr√¢nsito
- **TLS 1.3**: Todas as comunica√ß√µes
- **Certificate Pinning**: Apps m√≥veis
- **HSTS**: Headers de seguran√ßa

#### Dados em Repouso
- **AES-256**: Dados sens√≠veis
- **Database Encryption**: PostgreSQL TDE
- **File Encryption**: Documentos uploadados

### Auditoria

#### Logs de Auditoria
```json
{
  "timestamp": "2025-06-14T10:30:00Z",
  "user_id": "uuid",
  "action": "customer.create",
  "resource_id": "customer-uuid",
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0...",
  "details": {
    "fields_changed": ["email", "phone"],
    "old_values": {...},
    "new_values": {...}
  },
  "hash": "sha256:..."
}
```

## üìà Escalabilidade

### Horizontal Scaling

#### Microservi√ßos
- **Stateless**: Servi√ßos sem estado
- **Load Balancing**: Nginx/HAProxy
- **Auto Scaling**: Kubernetes HPA
- **Circuit Breaker**: Hystrix pattern

#### Database Scaling
- **Read Replicas**: PostgreSQL streaming
- **Partitioning**: Por data/regi√£o
- **Connection Pooling**: PgBouncer
- **Query Optimization**: √çndices, EXPLAIN

### Vertical Scaling

#### Resource Optimization
- **CPU**: Processamento ass√≠ncrono
- **Memory**: Cache inteligente
- **Storage**: Compress√£o, archiving
- **Network**: CDN, compression

### Caching Strategy

#### Multi-Layer Cache
```
Browser Cache (1h) ‚Üí CDN (24h) ‚Üí Redis (1w) ‚Üí Database
```

#### Cache Patterns
- **Cache-Aside**: Dados de clientes
- **Write-Through**: Configura√ß√µes
- **Write-Behind**: Logs de auditoria

## üìä Monitoramento

### M√©tricas de Sistema

#### Application Metrics
- **Response Time**: P50, P95, P99
- **Throughput**: Requests/second
- **Error Rate**: 4xx, 5xx errors
- **Availability**: Uptime percentage

#### Business Metrics
- **Customers Processed**: Por hora/dia
- **Screening Success Rate**: %
- **Document Processing Time**: M√©dia
- **False Positive Rate**: %

### Observabilidade

#### Logging
- **Structured Logs**: JSON format
- **Centralized**: ELK Stack
- **Correlation IDs**: Request tracing
- **Log Levels**: DEBUG, INFO, WARN, ERROR

#### Monitoring Stack
- **Prometheus**: M√©tricas
- **Grafana**: Dashboards
- **Jaeger**: Distributed tracing
- **AlertManager**: Alertas

#### Health Checks
```python
# Django health check
def health_check(request):
    checks = {
        'database': check_database(),
        'redis': check_redis(),
        'external_apis': check_external_apis(),
        'disk_space': check_disk_space()
    }
    
    status = 'healthy' if all(checks.values()) else 'unhealthy'
    
    return JsonResponse({
        'status': status,
        'checks': checks,
        'timestamp': timezone.now().isoformat()
    })
```

### Alerting

#### Alert Rules
- **High Error Rate**: > 5% em 5 minutos
- **High Response Time**: > 2s P95 em 10 minutos
- **Database Connections**: > 80% do pool
- **Disk Space**: < 10% dispon√≠vel

#### Notification Channels
- **Email**: Para alertas cr√≠ticos
- **Slack**: Para alertas de warning
- **PagerDuty**: Para alertas de produ√ß√£o
- **SMS**: Para alertas cr√≠ticos fora do hor√°rio

---

**¬© 2025 CERES. Sistema de Compliance e Avalia√ß√£o de Risco.**

